<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<script src="d3-scale-radial.js"></script>

<link rel="stylesheet" href="style.css">

<!-- visualization helpers -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- circular slider -->
<link rel="stylesheet" type="text/css" href="app.css">

<!-- font from Google API -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@350&display=swap" rel="stylesheet">

<!-- icons from Material Design -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<!-- tooltip helper -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<title>Musical Ties</title>


<!-- will move home to separate page at some point -->
<!-- <div style="display: flex; flex-direction: column; width: 100vw; margin: 0; padding: 0; max-width:100%; max-height:100%;">
  <b>Filter Playlist Attributes</b>
  <div style="display: flex; flex-wrap: wrap; justify-content: space-around;">
    <div style="display: flex; flex-direction: row;">
      <div>
        <label for="valence_min" class="form-label">valence</label>
        <p>min: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="valence_min">1.0</p>
        <p>max: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="valence_max">1.0</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: row;">
      <div>
        <label for="valence_min" class="form-label">danceability</label>
        <p>min: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="danceability_min">1.0</p>
        <p>max: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="danceability_max">1.0</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: row;">
      <div>
        <label for="valence_min" class="form-label">speechiness</label>
        <p>min: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="speechiness_min">1.0</p>
        <p>max: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="speechiness_max">1.0</p>
      </div>
    </div>
  </div>

  <div style="display: flex; flex-wrap: wrap; justify-content: space-around;">
    <div style="display: flex; flex-direction: row;">
      <div>
        <label for="valence_min" class="form-label">liveness</label>
        <p>min: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="liveness_min">1.0</p>
        <p>max: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="liveness_max">1.0</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: row;">
      <div>
        <label for="valence_min" class="form-label">energy</label>
        <p>min: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="energy_min">1.0</p>
        <p>max: 0.0<input type="range" min="0" max="1" step=".1" class="slider" id="energy_max">1.0</p>
      </div>
    </div>
  </div>-->
  <!-- <div>
    <b>Sort By Attribute</b>
    <select class="form-select" id="sort">
      <option selected>none</option>
      <option>valence</option>
      <option>danceability</option>
      <option>speechiness</option>
      <option>liveness</option>
      <option>energy</option>
    </select>
  </div>
    
</div> 

<div style="display: flex; width: 100vw; height: 70vh; margin: 0; padding: 0; max-width:100%; max-height:100%;">
  <div style="display: flex; width: 100%; height: 100%;">
    <svg id='home' width="100%" height="100%"></svg>
    <svg id='playlist' width="100%" height="100%"></svg>
  </div>
</div>
<div style="display: flex; flex-direction: row; justify-content: center;">
  <h4>My New Playlist</h4>
</div>
<div style="display: flex; justify-content: center; width: 100vw; height: 100vh; margin: 0; padding: 0; max-width:100%; max-height:100%;">
  <div>
    (click a song to add/remove)
    
  </div>
  
</div> -->
<div id="infoBlur" style=' background-color: rgba(46, 46, 46, 0.123); backdrop-filter: blur(5px); position : fixed; height:100vh; width: 100vw; visibility: hidden;'>

</div>
<div id='infoBar' style="position : fixed; height:100vh; width: 30vw; background-color: var(--background-light); visibility: hidden;">
  <div>Hey more info here</div>
  <div>that's so fucking cool </div>
  <div> thanks for the info so helpful</div>
  <span class="material-icons section-title" style="font-size: 40px; margin-right:-17px;" onclick="toggleInfoBar()">
    close
  </span>
</div>

<!-- I have this as position sticky rn to get it full width which i don't like but idk what else to do -->
<div class="row" style="visibility:visible; height:100vh; width:100vw; top: 0;left: 0; right: 0;" >
  <div class="col-1" id="menubar" style="width:auto; height:100vh;display:flex; flex-direction: column;">
    <span id="back" class="material-icons-outlined" onclick="goHome()" style="font-size: 40px; visibility: hidden;">arrow_back</span>
    <div id="infoIcon" class="material-icons-outlined section-title" style="color:#8a6eba; transform: rotate(-90deg); margin-left: -10px; margin-top: 150px; margin-bottom:-80px;  font-size: 40px; margin-right:-17px;" onclick="toggleInfoBar()">
      <!-- <span class="material-icons section-title" style="font-size: 40px; margin-right:-17px;" onclick="toggleInfoBar()"> -->
        info
      <!-- </span> -->
    </div>
    <div id="logo" style="color: var(--text-dark); font-size: 40px; margin:0px; padding: 0px; margin-top:200px; margin-left:-110px; margin-right:-140px; transform: rotate(-90deg); width:auto; height: auto;">
      MUSICAL TIES
    </div>
    <!-- <div>Do you know how to make this column as narrow as possible?</div> -->
  </div>
  <div class="col section-view" id="playlist-view">
    <!-- PLAYLIST EXPLORATION -->
    <div class="full-height-div">
      <div class="section-title" id="left-title">playlist exploration</div>

      <div class="fill-remaining-space-div" style="overflow-y:scroll">
        <svg id='home' class="collapse show" width="100%" height="100%" style="vertical-align: top;"></svg>
        <svg id='playlist' class="collpase" width="100%" height="100%"></svg>
        <div id="left-player">
        </div>
        <button type="button" class="btn btn-secondary" id="add-song" style="visibility: hidden">add this song to my playlist</button>
        <ul class="list-group" id="songs"></ul>
      </div>
    </div>
  </div>
  <div class="col-3 section-view section-view-right" id="right-panel">
    <div class="full-height-div">
      <div class="section-title" id="right-title"></div>
      <div class="fill-remaining-space-div" style="overflow-y:scroll">
        <div id="sliders"></div>
        <svg id='your-playlist' class="collpase" width="100%" height="100%"></svg>
        <div id="right-player"></div>
        <ul class="list-group" id="custom-songs"></ul>
      </div>
    </div>
  </div>
</div>


<style>
  body {
    background-color: var(--background-light);
    color: var(--text-light);
    font-family: 'Josefin Sans', sans-serif;
    font-weight: 300; 
    overflow: hidden;
  }
</style>

<script type="text/javascript" src="app.js"></script>

<script>

var yourPlaylist = {
  'id' : "new1",
  'name' : 'Your Playlist',
  'track_ids' : []
};

function removeSong(song) {
  song.parentElement.remove();
  yourPlaylist.track_ids = yourPlaylist.track_ids.filter(s => s !== song.parentElement.id);
}

var infoBarVisible = false; 
function toggleInfoBar(){
  infoBarVisible = !infoBarVisible; 
  if(infoBarVisible){
    document.getElementById("infoBar").style.visibility = "visible"; 
    document.getElementById("infoBlur").style.visibility = "visible"; 
    document.getElementById("logo").style.visibility = "hidden"; 
    document.getElementById("infoIcon").style.visibility = "hidden"; 
  }
  else{
    document.getElementById("infoBar").style.visibility = "hidden"; 
    document.getElementById("infoBlur").style.visibility = "hidden"; 
    document.getElementById("logo").style.visibility = "visible"; 
    document.getElementById("infoIcon").style.visibility = "visible"; 
  }
}

// TODO: fix this
function goHome() {
  // svgHome = d3.select("body").append("svg").attr("width", 50).attr("height", 50);
  d3.select("svg#playlist").remove();
  d3.select("svg#your-playlist").remove();
  d3.select("#right-panel").attr('class','col-3 section-view section-view-right');
  document.getElementById("back").style.visibility = "hidden"; 
  // TODO: this might be problematic bc not properly deleted
  document.getElementById('add-song').style.visibility = 'hidden';
  document.getElementById('songs').style.visibility = 'hidden';
  document.getElementById('custom-songs').style.visibility = 'hidden';
  d3.select('#left-title').text('playlist exploration');
  drawYourPlaylistBubble(); 
  // bubbleData = getBubbleData();
  drawBubbles();
  // if (yourPlaylist.track_ids.length > 0)
  //   drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title');
}

d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-musical-ties/main/data/playListDataList.json").then(playlistData => {
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-musical-ties/main/data/trackData.json").then(trackData => {
  var ourWhite = "#ECEAF2"; 

  // append the svg object to the body of the page
  var svgHome = d3.select("svg#home")
  var widthHome = $("svg#home").width()
  var heightHome = $("svg#home").height()
  // svgHome.attr("viewBox", "0,0," + widthHome + "," + heightHome)

  // COLORS AND VISUAL VARIABLES
  // colors of features
  var colors = ["#FFB0C2", "#FF6DB5", "#FF29D8", "#C02CE6", "#7C30FF"]; 
    // var colors = ["#ffe942", "#ff7e38", "#FF29D8", "#C02CE6", "#7C30FF"]; 

  // colors = colors.reverse(); 
  var colorsBright = ["#FFD7E0", "#FFDEEF", "#FFCAF5", "#F2BCFF", "#DAC5FF", "#ffa83d"]; 

  // record colors 
  var darkerRecord = "#2d2b36";
  var lighterRecord = "#413f4a";
  
  // grid variables
  // it's all dependent on first variable 
  var numGridCols = 3; 
  var bubbleSize = (widthHome / (numGridCols + 1)) / 2; 
  var spacing = (widthHome / (numGridCols + 1)) / (numGridCols + 1) ; 
  var gridLeftOffset = spacing + (bubbleSize); 
  var gridTopOffset = gridLeftOffset; 
  var gridSpacingHorizontal = (bubbleSize*2) + spacing; 
  var gridSpacingVertical = gridSpacingHorizontal + 20; 

  var centerBubbleSize = bubbleSize / 3; 

  // order and values can be changed
  var features = [ "danceability", "energy", "valence", "liveness", "speechiness"]; 
  features = features.reverse(); 

  var tooltip = d3.select("body").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);

  function getPlaylistInfo(pID){
    for (p of playlistData) {
      if(p.id == pID){
        return p; 
      }
    }
  }
  
  // playlistData = playlistData.filter(playlist => !(playlist['name'] in ['mint', 'Lorem', 'Heart of Texas'])); 

  // var sortselect = document.getElementById('sort');
  // sortselect.onchange = function(){
  //   const feature = document.getElementById('sort').value;
  //   if (feature === 'none'){
  //     svgHome.selectAll("circle")
  //     .style("fill-opacity", .3 )
  //     .style("fill", '#69b3a2'); 
  //   } else {
  //     var fIndex = features.indexOf(feature); 
  //     svgHome.selectAll("circle")
  //     .style("fill-opacity", function(d) {
  //       return getAverage(d, feature); 
  //     })
  //     .style("fill", colors[fIndex]); 
  //   }
    
  // };

  var examplePlaylist;

  const feature_sliders = {
    DOMselector: '#sliders',
    sliders: []
  };

  let current_radius = 40;
  for (let i=0; i<features.length; i++){
    const current_slider = {
      radius: current_radius+20*i,
      min: 0,
      max: 1,
      step: .1,
      initialValue: 1,
      color: colors[i],
      displayName: features[i]
    };
    feature_sliders.sliders.push(current_slider);
  }
  // instantiate the slider
  const slider = new Slider(feature_sliders);
  slider.draw();

  function getBubbleData() {
    let data = [];
    let counted = []; 
    for (p of playlistData) {
      if(!(['mint', 'Lorem', 'Heart Of Texas', "Today's Top Hits", 'POLLEN', 'Beast Mode Hip-Hop', 'RADAR Country', 'Rock This', "Chillin' on a Dirt Road", "Ultimate Indie", "my life is a movie", "Breakout Country", "Pop Rising", "Teen Beats",  "I Love My '00s R&B"].includes(p.name))){
        if(!counted.includes(p.name)){
          let bubble = {};
          bubble.name = p['id'];
          data.push(bubble);
          counted.push(p.name); 
        }
      }
    }
    return data;
  }
   
  var bubbleData = getBubbleData();

  // sets SVG height to height of playlists 
  var numRows = Math.ceil((bubbleData.length + 1) / numGridCols); 
  var fullHeight = (numRows * gridSpacingVertical) + (gridTopOffset) - spacing*2; 
  d3.select("svg#home").attr("height", "" + fullHeight + "px" ); 

  // input: playlist is entire playlist dictionary
  function getAverage(playlist, feature){
      return getAverageFromID(playlist.name, feature); 
  }

  // input: playlistID is just the ID
  function getAverageFromID(playlistID, feature){
    var sum = 0; 
    var total = 0; 
    for(p of playlistData ){
      if(p.id == playlistID){
        for(song of p['track_ids']){
          sum += trackData[song]['features'][feature]; 
        }
        total = p['track_ids'].length; 
        return sum / total; 
      }
    }
  }

  // returns an array of the average features
  function getAverageFeatures(playlistID){
    var feats = [];
    for(var i = 0; i < features.length; i++){
      feats.push(getAverageFromID(playlistID, features[i]));
    }
    return feats; 
  }

  // get average features for your new playlist
  function getYourAverageFeatures(){
    var feats = [];
    for(var i = 0; i < features.length; i++){
      var sum = 0; 
      var total = 0; 
      for(song of yourPlaylist['track_ids']){
        sum += trackData[song]['features'][features[i]];
      }
    }
    return feats; 
  }

  // not in use
  function colorBubbles(feature){
    var fIndex = features.indexOf(feature); 
    currentColor = colors[fIndex];

    svgHome.selectAll("circle")
    .style("fill-opacity", function(d) {
      return getAverage(d, feature); 
    }).style("fill", currentColor); 
  }

  // needed this to be global variable so i can update the positions of the playlist titles
  // might be a better way 
  var titles; 

  // scales for bubbles
  var myx = d3.scaleLinear()
    .range([0, 2 * Math.PI])
    .domain([0, 1]);

  var myy = d3.scaleLinear()
    .range([centerBubbleSize, bubbleSize])
    .domain([0, 5]);

  // Initialize the circle: all located at the center of the svg area
  function drawBubbles() {
    var node = svgHome.selectAll("g.otherPlaylists")
      .data(bubbleData)
      .join(
        enter  => enter.append('g'),
        update => update,
        exit   => exit.remove()
      )
      .attr('id', function(d) { return 'p' + d.name})
      .classed('otherPlaylists', true);

    // draws the black record
    node
      .append("g")
      .selectAll("g")
      .data([5, 4, 3, 2, 1, 0])
      .enter().append("circle")
      .classed('disk', true)
      .style("fill", function(d) { if(d % 2 == 0){ return darkerRecord} return lighterRecord })
      .attr('r', function(d) {return myy(d)})

    // draws the colors on the record
    var bars = node
    .append('g')
    .selectAll('path')
    .data(function(d) {return getAverageFeatures(d.name)}) // map to index, and maybe you can calculate the feature list here and then go from there 
    .enter().append("path")
    .style("fill", function(d, i) { return colors[i] })
      .attr("d", d3.arc() 
        .innerRadius(function(d, i) { return myy(i); })
        .outerRadius(function(d, i) { return myy(i + 1); })
        .startAngle(function(d) { return 0 })
        .endAngle(function(d) { return myx(d); })
        .padAngle(0.005)
        // .padRadius(innerRadius)
      )
      .attr('id', function(d, i){ return features[i]})

    // TODO no longer in use, move click functionality
    // // draws a transparent circle that is meant for detection
    // node
    //   .append("g")
    //   .selectAll("g")
    //   .data(function(d) {return [d]})
    //   .enter().append("circle")
    //   .classed('detect', true)
    //   .style("opacity", "0")
    //   .attr('r', bubbleSize)
    //   .on("click", function(event, d){
    //       // svgHome.selectAll('circle').data(bubbleData).exit().remove();  
    //       examplePlaylist = playlistData.filter(p => p.id === d.name)[0];
    //       bubbleData = [];
    //       drawBubbles();
    //       drawPlaylist();
    //   })

    // playlist title
    titles = node
      .append("g")
      .classed("title", true)
      .selectAll("g.title")
      .data(function(d) {return [d]})
      .enter()
      .append("text")
      // .classed(function(d) {return 'playlistTitle' + d.name}, true)
      .text(function(d) { return getPlaylistInfo(d.name).name})
      // .style("opacity", 0)
      .style("fill", ourWhite)
      .style("font-size", "22px")
      .on("mouseover", function(event, d){
        // console.log(this.getAttribute('class')); 
      }); 

    // add classname for each title text
    titles.each(function(d) {
      this.classList.add("playlistTitle" + d.name);
    });


    // this is a really jank way to make the tool tips on the rings work 
    // invisible concentric bubbles that allow for tooltips
    node
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter().append("circle")
      .classed('disk', true)
      .attr("id", function(d) {return "ring" + d.name + "-" + 5})
      .style("opacity",  0)
      .attr('r', myy(5))
      .on("mouseenter", function(event, d){
        d3.select('#p' + d.name).select("#" + features[4]).style('fill', colorsBright[4])
      })
      .on("mouseleave", function(event, d){
        d3.select('#p' + d.name).select("#" + features[4]).style('fill', colors[4])
      })

    // invisible concentric bubbles that allow for tooltips
    node
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter().append("circle")
      .classed('disk', true)
      .attr("id", function(d) {return "ring" + d.name + "-" + 4})
      .style("opacity",  0)
      .attr('r', myy(4))
      .on("mouseenter", function(event, d){
        d3.select('#p' + d.name).select("#" + features[3]).style('fill', colorsBright[3])
      })
      .on("mouseleave", function(event, d){
        d3.select('#p' + d.name).select("#" + features[3]).style('fill', colors[3])
      })

    // invisible concentric bubbles that allow for tooltips
    node
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter().append("circle")
      .classed('disk', true)
      .attr("id", function(d) {return "ring" + d.name + "-" + 3})
      .style("opacity",  0)
      .attr('r', myy(3))
      .on("mouseenter", function(event, d){
        d3.select('#p' + d.name).select("#" + features[2]).style('fill', colorsBright[2])
      })
      .on("mouseleave", function(event, d){
        d3.select('#p' + d.name).select("#" + features[2]).style('fill', colors[2])
      })

    // invisible concentric bubbles that allow for tooltips
    node
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter().append("circle")
      .classed('disk', true)
      .attr("id", function(d) {return "ring" + d.name + "-" + 2})
      .style("opacity",  0)
      .attr('r', myy(2))
      .on("mouseenter", function(event, d){
        d3.select('#p' + d.name).select("#" + features[1]).style('fill', colorsBright[1])
      })
      .on("mouseleave", function(event, d){
        d3.select('#p' + d.name).select("#" + features[1]).style('fill', colors[1])
      })

    // invisible concentric bubbles that allow for tooltips
    node
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter().append("circle")
      .classed('disk', true)
      .attr("id", function(d) {return "ring" + d.name + "-" + 1})
      .style("opacity",  0)
      .attr('r', myy(1))
      .on("mouseenter", function(event, d){
        d3.select('#p' + d.name).select("#" + features[0]).style('fill', colorsBright[0])
      })
      .on("mouseleave", function(event, d){
        d3.select('#p' + d.name).select("#" + features[0]).style('fill', colors[0])
      })

    // invisible concentric bubbles that allow for tooltips
    node
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter().append("circle")
      .classed('disk', true)
      .classed('clicky-disk', true)
      .attr("id", function(d) {return "ring" + d.name + "-" + 0})
      .style("opacity",  0)
      .attr('r', myy(0))
      .on("click", function(event, d){
        // TODO for now this can be where you click to show playlist view
        d3.select("svg#home").remove();
        d3.select("#right-panel").attr('class','col section-view section-view-right');
        document.getElementById("back").style.visibility = "visible"; 
        examplePlaylist = playlistData.filter(p => p.id === d.name)[0];
        drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title'); 
        if (yourPlaylist.track_ids.length > 0)
          drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title');
      })

      movePlaylists(); 
  }

  function drawYourPlaylistBubble(){
    var yourNode = svgHome.selectAll("g")
      .data([yourPlaylist])
      .join(
        enter  => enter.append('g'),
        update => update,
        exit   => exit.remove()
      )
      .attr('id', function(d) { return 'p' + d.id})

      var colors = [ 'rgb(48, 46, 56)', 'rgb(23, 22, 27)' ];

      var grad = svgHome.append('defs')
      .append('linearGradient')
      .attr('id', 'grad')
      .attr('x1', '0%')
      .attr('x2', '0%')
      .attr('y1', '0%')
      .attr('y2', '100%');

      grad.selectAll('stop')
      .data(colors)
      .enter()
      .append('stop')
      .style('stop-color', function(d){ return d; })
      .attr('offset', function(d,i){
        return 100 * (i / (colors.length - 1)) + '%';
      })

    var yourRect = yourNode
      .append("g")
      .selectAll("g")
      .data(function(d) {return [d]})
      .enter()
      .append("rect")
      .classed('filled', true)
      .attr("rx", 6)
      .attr("ry", 6)
      .attr("width", bubbleSize*2 + (spacing / 2))
      .attr("height", bubbleSize*2 + spacing)
      .attr("fill", 'url(#grad)')
      .attr("stroke", "#69647d")
      .attr("stroke-width", "2px")

    // draws the black record
    yourNode
      .append("g")
      .selectAll("g")
      .data([5, 4, 3, 2, 1, 0])
      .enter().append("circle")
      .classed('disk', true)
      .style("fill", function(d) { if(d % 2 == 0){ return darkerRecord} return lighterRecord })
      .attr('r', function(d) {return myy(d)})

    // draws the colors on the record
    yourNode
    .append('g')
    .selectAll('path')
    .data(getYourAverageFeatures()) // map to index, and maybe you can calculate the feature list here and then go from there 
    .enter().append("path")
    .style("fill", function(d, i) { return colors[i] })
      .attr("d", d3.arc() 
        .innerRadius(function(d, i) { return myy(i); })
        .outerRadius(function(d, i) { return myy(i + 1); })
        .startAngle(function(d) { return 0 })
        .endAngle(function(d) { return myx(d); })
        .padAngle(0.005)
        // .padRadius(innerRadius)
      )
      .attr('id', function(d, i){ return features[i]})

    // playlist title
    yourTitle = yourNode
      .append("g")
      .classed("title", true)
      .selectAll("g.title")
      .data(function(d) {return [d]})
      .enter()
      .append("text")
      // .classed(function(d) {return 'playlistTitle' + d.name}, true)
      .text(function(d) { return d.name})
      // .style("opacity", 0)
      .style("fill", ourWhite)
      .style("font-size", "22px")
      .on("mouseover", function(event, d){
        // console.log(this.getAttribute('class')); 
      }); 

    // add classname for each title text
    yourTitle.each(function(d) {
      this.classList.add("playlistTitle" + d.id);
    });

    // var pid = 
    // this is a really jank way to make the tool tips on the rings work 
    // invisible concentric bubbles that allow for tooltips
    yourNode
      .append("g")
      .selectAll("g")
      .data([5, 4, 3, 2, 1, 0])
      .enter().append("circle")
      .classed('disk', true)
      .attr("id", function(d) {return "ring" + yourPlaylist.id + "-" + d})
      .style("opacity",  0)
      .attr('r', function(d) {return myy(4)})
      .on("mouseenter", function(event, d){
        if(d > 0){
          d3.select('#p' + yourPlaylist.id).select("#" + features[d - 1]).style('fill', colorsBright[d - 1])
        }
      })
      .on("mouseleave", function(event, d){
        if(d > 0){
          d3.select('#p' + yourPlaylist.id).select("#" + features[d - 1]).style('fill', colors[d - 1])
        }
        
      })

    yourNode.attr("transform", "translate(" + (gridLeftOffset) + "," + (gridTopOffset) + ")");
    yourTitle.each(function(d) {
      var width = this.getBBox().width; 
      this.setAttribute("transform", "translate(" + (-0.5 * width) + "," + (-(bubbleSize + 10 ) ) + ")");
    });
    yourRect.each(function(d) {
      var width = this.getBBox().width; 
      var height = this.getBBox().height; 
      this.setAttribute("transform", "translate(" + (-0.5 * width) + "," + ((-0.5 * height) - 10) + ")");
    });
    // yourTitle.attr("transform", "translate(" + (-0.5 * width) + "," + (-(bubbleSize + 10 ) ) + ")");
      // movePlaylists(); 
  }

  drawYourPlaylistBubble(); 

  drawBubbles();

  // Use to update positions of playlists based on new ordering in bubbleData
  function movePlaylists(){
    var jankRowCount = 0; 
    var jankColCount = 1; 
    for(bub of bubbleData){
      d3.select('#p' + bub.name).attr("transform", "translate(" + (gridLeftOffset + jankColCount * gridSpacingHorizontal) + "," + (gridTopOffset + jankRowCount * gridSpacingVertical) + ")");
      jankColCount += 1; 
      if(jankColCount > numGridCols - 1){
        jankColCount = 0; 
        jankRowCount += 1; 
      }
    }
    titles.each(function(d) {
      var width = this.getBBox().width; 
      this.setAttribute("transform", "translate(" + (-0.5 * width) + "," + (-(bubbleSize + 10 ) ) + ")");
    });
  }

  // this is another jank solution but the only way i can think to easily hide the playlists
  // numToRemove is the number of playlists hidden, 
  // and they should all be moved to the end in bubbleData and physically moved with movePlaylists() in order for this to work 
  function hidePlaylists(numToRemove){
    var data = [];
    for(var i = 0; i < numToRemove; i++){
      data.push(i);
      var pName = bubbleData[bubbleData.length - 1 - i].name; 
      d3.selectAll("text.playlistTitle" + pName).style('opacity', 0.3); 
    }

    svgHome
      .append("g")
      .classed('myHide', true)
      .selectAll("g.myHide")
      .data(data)
      .enter()
      .append('circle')
      .attr('r', bubbleSize)
      .style('fill', '#17161B99')
      .attr("transform", function(d){ return "translate(" + getCircleX(d) + "," + getCircleY(d) + ")"})
  }

  function getCircleX(offset){
    var arrayLoc = bubbleData.length + 1 - offset; 
    var row = Math.ceil(arrayLoc / numGridCols); 
    var col = numGridCols; 
    while(((row - 1) * numGridCols) + col != arrayLoc){
      col -= 1; 
      if(col <= 0){
        col = numGridCols - 1; 
        row = row - 1; 
      }
    }
    col = col - 1; 
    return (gridLeftOffset + col * gridSpacingHorizontal);
  }

  function getCircleY(offset){
    var arrayLoc = bubbleData.length + 1 - offset; 
    var row = Math.ceil(arrayLoc / numGridCols); 
    row = row - 1; 
    return (gridTopOffset + row * gridSpacingVertical); 
  }

  function addBubbleToolTips(){
    // add tooltips for each playlist in playlist view 
    for(bub of bubbleData){
      // for each feature
      var featureVals = getAverageFeatures(bub.name); 

      for(var i = 0; i < features.length; i++){
        var elementId = "#ring" + bub.name + "-" + (i + 1) ; 
        tippy(elementId, {
          content: "" + features[i] + " : " + featureVals[i].toFixed(2),
          followCursor: true,
          placement: 'left',
          theme: features[i],
          
          arrow: false,
        });
      }
    }
    tippy(".clicky-disk", {
          content: "click for more info",
          followCursor: true,
          placement: 'bottom',
          // theme: features[i],
          
          arrow: false,
          delay: [500, null],
        });
    }
    addBubbleToolTips(); 
  


  //how do i make this cleaner?
  // d3.select('#valence_min').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'valence') >= this.value);

  //   drawBubbles();
  // });

  // d3.select('#danceability_min').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'danceability') >= this.value);
  //   drawBubbles();
  // });

  // d3.select('#speechiness_min').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'speechiness') >= this.value);
  //   drawBubbles();
  // });

  // d3.select('#liveness_min').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'liveness') >= this.value);
  //   drawBubbles();
  // });

  // d3.select('#energy_min').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'energy') >= this.value);
  //   drawBubbles();
  // });

  // d3.select('#valence_max').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'valence') <= this.value);
  //   drawBubbles();
  // });

  // d3.select('#danceability_max').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'danceability') <= this.value);
  //   drawBubbles();
  // });

  // d3.select('#speechiness_max').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'speechiness') <= this.value);
  //   drawBubbles();
  // });

  // d3.select('#liveness_max').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'liveness') <= this.value);
  //   drawBubbles();
  // });

  // d3.select('#energy_max').on("input", function() {
  //   svgHome.selectAll('circle').data(bubbleData).exit().remove(); 
  //   bubbleData = getBubbleData().filter(b => getAverage(b, 'energy') <= this.value);
  //   drawBubbles();
  // });
  
  // TODO width and height will probs need to be different when not in full screen viewing
  // note that these are reinitialized in drawPlaylist to change width and height for new page
  // not sure if this will cause bugs later?
  var svg = d3.select("svg#playlist").attr("preserveAspectRatio", "xMinYMin meet"); 
    // width = $("svg#playlist").width(),
    // height = $("svg#playlist").height(),
    // innerRadius = Math.min(width, height) / 15,
    // outerRadius = Math.min(width, height) / 2.5,
    // g = svg.append("g")
    //   .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")"); 

  var yourSvg = d3.select("svg#your-playlist").attr("preserveAspectRatio", "xMinYMin meet");
    // yourwidth = $("svg#your-playlist").width(),
    // height = $("svg#your-playlist").height(),
    // innerRadius = Math.min(width, height) / 6,
    // outerRadius = Math.min(width, height) / 2,
    // yourG = svg.append("g")
    //   .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")"); 
  

  function getBrighterByFeature(feature){
    var ind = features.indexOf(feature); 
    return colorsBright[ind];
  }

  function getDarkerByFeature(feature){
    var ind = features.indexOf(feature); 
    return colors[ind];
  }

  function getBrighterByColor(color){
    for(var i = 0; i < colors.length; i++){
      if(d3.rgb(colors[i]) == color){
        return colorsBright[i]; 
      }
    }

    return color;
  }

  function getDarkerByColor(color){
    for(var i = 0; i < colorsBright.length; i++){
      if(d3.rgb(colorsBright[i]) == color){
        return colors[i]; 
      }
    }
    return color;
  }

  var selectedSong = ""; 

  function drawPlaylist(currentPlaylist, svg, svg_id, panel_id){
    width = $(svg_id).width(),
    height = $(svg_id).height(); 
    let factor = 0.8; 
    let innerRadius = Math.min(width, height) / 20; 
    let outerRadius = Math.min(width, height) / 2;
    let g = svg.append("g")
      .attr("transform", "translate(" + width / 2 + "," + outerRadius * factor + ")"); 

    var y = d3.scaleRadial()
    .range([innerRadius, outerRadius])
    .domain([0, 5]);

    svg.selectAll('path').data(currentPlaylist['track_ids']).exit().remove(); 
    drawPlaylistLegend(currentPlaylist, svg, g, outerRadius, factor);
    updatePlaylistDisplayInfo([currentPlaylist["name"]], g, outerRadius, factor);
    d3.select(panel_id).text(currentPlaylist["name"]);

    var x = d3.scaleBand()
    .range([0, 2 * Math.PI])
    .align(0)
    .domain(currentPlaylist["track_ids"]);

    features.forEach((feature, i) => {
      g.append('g')
        .selectAll('path')
        .data(currentPlaylist['track_ids'])
        .join(
          enter => enter.append('path'),
          update => update,
          exit   => exit.remove()
        )
        .classed(feature, true)
        .style("fill", colors[i])
          .attr("d", d3.arc() 
              .innerRadius(function(d) { return y(getFeatureStartPos(d, i)); })
              .outerRadius(function(d) { return y(getFeatureEndPos(d, i)); })
              .startAngle(function(d) { return x(d); })
              .endAngle(function(d) { return x(d) + x.bandwidth(); })
              .padAngle(0.005)
              .padRadius(innerRadius)
              )
      }); 

      g.append('g')
        .selectAll('path')
        .data(currentPlaylist['track_ids'])
        .join(
          enter => enter.append('path'),
          update => update,
          exit   => exit.remove()
        )
        .attr("opacity","0")
        .attr("d", d3.arc() 
          .innerRadius(function(d) { return y(0); })
          .outerRadius(function(d) { return y(5); }) // this val could be improved but whatever for now
          .startAngle(function(d) { return x(d); })
          .endAngle(function(d) { return x(d) + x.bandwidth(); })
          .padAngle(0.01)
          .padRadius(innerRadius)
          )
        .on("click", function(event, d, i){
          d3.select('#add-song').style('visibility', 'hidden');
          displaySongInfoPlaylist(d, g, outerRadius, factor); 
          svg.selectAll("path")
            .filter(d => d == selectedSong)
            .style("fill", function(d){ return getDarkerByColor(this.style.fill)}) 
          selectedSong = d;
          svg.selectAll("path")
            .filter(d => d == selectedSong)
            .style("fill", function(d){ return getBrighterByColor(this.style.fill)})
          if (currentPlaylist === examplePlaylist){
            if (!yourPlaylist.track_ids.includes(selectedSong))
              d3.select('#add-song').style('visibility', 'visible')

            let player = document.getElementById('left-player');
            player.innerHTML = `<iframe  src="https://open.spotify.com/embed/track/${d}" width="250" height="100" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
          } else {
            let player = document.getElementById('right-player');
            player.innerHTML = `<iframe  src="https://open.spotify.com/embed/track/${d}" width="250" height="100" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
          }

          
          
        })
        // .on("mouseout", function(event, d, i){
        //   // TODO i'm not sure this will work when we scale up
        //   updatePlaylistDisplayInfo([currentPlaylist["name"]]);
        //   var selectedSong = d;
        //   svg.selectAll("path")
        //     .filter(d => d == selectedSong)
        //     .style("fill", function(d){ return getDarkerByColor(this.style.fill)})
        // })

    let playlist = document.getElementById('songs');
    for (track of currentPlaylist['track_ids']) {
      let song = document.createElement('li');
      song.className = "list-group-item list-group-item-dark";
      song.id = track;
      song.innerHTML = trackData[track].title;
      playlist.appendChild(song);
    }

  }

  const addButton = document.getElementById('add-song');
  addButton.onclick = function() {
    let playlist = document.getElementById('custom-songs');
    let song = document.createElement('li');
    song.className = "list-group-item list-group-item-dark";
    song.id = selectedSong;
    song.innerHTML = `${trackData[selectedSong].title}<span class="material-icons" onclick="removeSong(this)">delete</span>`;
    playlist.appendChild(song);
    yourPlaylist.track_ids.push(selectedSong);
    drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title');
    d3.select('#add-song').style('visibility', 'hidden')
  }

  function displaySongInfoPlaylist(songID, g, outerRadius, factor){
    var songInfo = trackData[songID]; 
    var songFeatures = [songInfo['title']]; 
    for(var i = 0; i < features.length; i++){
      let info = "" + features[i] + " " + songInfo['features'][features[i]]; 
      songFeatures.push(info); 
    }
    updatePlaylistDisplayInfo(songFeatures, g, outerRadius, factor); 
  }

  function drawPlaylistLegend(examplePlaylist, svg, g, outerRadius, factor){
    // svg.selectAll('path').exit().remove(); 
    g.selectAll('rect.legend').data(features).join(
      enter => enter.append("rect"),
      update => update,
      exit   => exit.remove()
    )
    .style('cursor', 'pointer')
    .style("fill", function(d) {return colors[features.indexOf(d)]})
    .attr("stroke-width", 2)
    // .attr("fill-opacity", .4)
    .attr("width", 18)
    .attr("height", 18)
    .classed('legend', true)
    .attr("opacity", "1")
    .text(d => d)
    .attr("transform", (d, i) => `translate(${(-outerRadius)},${(i * 20 + 5 + outerRadius * factor)})`)
    .on("mouseenter", function(event, d){
      var objClass = "path." + d; 
      svg.selectAll(objClass).style("fill", getBrighterByFeature(d))
    })
    .on("mouseout", function(event, d){
      var objClass = "path." + d; 
      svg.selectAll(objClass).style("fill", getDarkerByFeature(d))
    })
    .on("click", function(event, d){
      // TODO: do all this for custom playlist too
      var objClass = "path." + d; 
      svg.selectAll('path').data(examplePlaylist['track_ids']).exit().remove(); 
      examplePlaylist['track_ids'] =  sortByFeature(examplePlaylist, examplePlaylist['track_ids'], d); 
      // svg.selectAll(objClass).style("fill", getBrighter(this.style.fill))
      drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title'); 
      svg.selectAll(objClass).style("fill", getBrighterByFeature(d)); 

      colorBubbles(d); 
    })
  }

  function updatePlaylistDisplayInfo(title, g, outerRadius, factor){
    if(title.length == 1){
      for(var i = 0; i < features.length; i++){
        title.push(features[i]); 
      }
    }

    // middle of playlist text
    g.selectAll("text.playlistInfo").exit().remove(); 
    g.selectAll("text.playlistInfo").data(title).join(
      enter => enter.append("text"),
      update => update,
      exit   => exit.remove()
    )
    .style("fill", "white")
    .attr("stroke-width", 2)
    // .attr("fill-opacity", .4)
    .classed('playlistInfo', true)
    .text(d => d)
    .attr("transform", (d, i) => `translate(${-outerRadius + 20},${(i * 20) + (outerRadius * factor)})`); 
  }

  function sortByFeature(examplePlaylist, songs, feature){
    // TODO might be better to not sort the original array? how do you get back to original config... hmm 
    svg.selectAll('path').data(examplePlaylist['track_ids']).exit().remove();
    
    songs.sort(function(a, b) {
      return trackData[a]["features"][feature] - trackData[b]["features"][feature]; 
    }); 

    x = d3.scaleBand()
      .range([0, 2 * Math.PI])
      .align(0)
      .domain(songs);
    return songs; 
  }

  function getFeatureStartPos(songId, featureIndex){
    var total = 0;  
    for(var i = 0; i < featureIndex; i++){
      total += trackData[songId]["features"][features[i]];
    }
    return total; 
  }

  function getFeatureEndPos(songId, featureIndex){
    var total = getFeatureStartPos(songId, featureIndex);  
    total += trackData[songId]["features"][features[featureIndex]];
    return total; 
  }

  // d3.select("svg#home").remove();

}); 
  
}); 


</script>