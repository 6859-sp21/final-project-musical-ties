<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<script src="d3-scale-radial.js"></script>

<link rel="stylesheet" href="style.css">

<!-- visualization helpers -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- circular slider -->
<link rel="stylesheet" type="text/css" href="app.css">

<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
<link href="https://cdn.jsdelivr.net/npm/round-slider@1.6.1/dist/roundslider.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/round-slider@1.6.1/dist/roundslider.min.js"></script>


<!-- font from Google API -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@350&display=swap" rel="stylesheet">

<!-- icons from Material Design -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<!-- tooltip helper -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<title>Musical Ties</title>

<div id="infoBlur" style=' background-color: rgba(46, 46, 46, 0.123); backdrop-filter: blur(5px); position : fixed; height:100vh; width: 100vw; visibility: hidden;'>

</div>
<div id='infoBar' style="left: 0; position : fixed; height:100vh; width: 30vw; background-color: var(--background-light); visibility: hidden; padding: 10px; padding-left: 30px;">
  <div class="material-icons section-title" style="font-size: 40px; margin-right:-17px; width: 100%; display: flex; justify-content: flex-end;" onclick="toggleInfoBar()">
    close
  </div>
  <div class="section-title" style="padding-left: 0px;">Musical Ties </div>
  <div class="help-info">Musical Ties is a platform that allows you to visually curate your own playlists.</div>
  <div class="help-info">Explore existing playlists to see what metrics they have, and the songs within them. Use the visual metrics to help you decide what type of playlist you want to create.</div>
  <div class="help-info" style="color: var(--text-dark)">data source: Spotify API</div> 

</div>

<!-- I have this as position sticky rn to get it full width which i don't like but idk what else to do -->
<div class="row" style="visibility:visible; height:100vh; width:100vw; top: 0;left: 0; right: 0;" >
  <div class="col-1" id="menubar" style="width:auto; height:100vh;display:flex; flex-direction: column;">
    <div style=" margin-left: -10px; margin-bottom:-80px;  font-size: 40px; margin-right:-17px;">
      <span id="back" class="material-icons-outlined section-title" onclick="goHome()" style="font-size: 40px; margin:0px;">arrow_back</span>
    </div>
      <div id="infoIcon" class="material-icons-outlined section-title" style="color:#8a6eba; transform: rotate(-90deg); margin-left: -10px; margin-top: 150px; margin-bottom:-80px;  font-size: 40px; margin-right:-17px;" onclick="toggleInfoBar()">
      <!-- <span class="material-icons section-title" style="font-size: 40px; margin-right:-17px;" onclick="toggleInfoBar()"> -->
        info
      <!-- </span> -->
    </div>
    <div id="logo" style="color: var(--text-dark); font-size: 40px; margin:0px; padding: 0px; margin-top:200px; margin-left:-110px; margin-right:-140px; transform: rotate(-90deg); width:auto; height: auto;">
      MUSICAL TIES
    </div>
  </div>
  <div class="col section-view" id="playlist-view">
    <!-- PLAYLIST EXPLORATION -->
    <div class="full-height-div">
      <div class="section-title" id="left-title">playlist exploration</div>

      <div class="fill-remaining-space-div" style="overflow-y:scroll">
        <svg id='playlist' class="collpase" width="100%" height="100%"></svg>
        <div id="left-player"></div>
        <div id="left-song-plot"></div>
        <button type="button" class="btn btn-secondary" id="add-song" style="visibility: hidden">add this song to my playlist</button>
        <ul class="list-group" id="songs" style="max-height: 250px; overflow-y:scroll"></ul>
      </div>
    </div>
  </div>

  <div class="col-3 section-view section-view-right" style="overflow-y:scroll">
    <div class="full-height-div">
      <div class="fill-remaining-space-div" style="overflow-y:auto; overflow-x: hidden">
        <div id="sorting"></div>
        <div class="section-title">filter playlists</div>
        <div class="row">
          <div class="col-9" id="sliders"></div>
          <div class="col" id="slider-values"></div>
        </div>
      <!-- <div id='compare-songs' width="100%" height="100%"></div> -->
      <!-- formatting gets weird if I removed these divs even though theyre not used -->
     <!--  <svg id="compare-speechiness" width="100%" height="100%"></svg>
      <svg id="compare-liveness" width="100%" height="100%"></svg>
      <svg id="compare-valence" width="100%" height="100%"></svg>
      <svg id="compare-energy" width="100%" height="100%"></svg>
      <svg id="compare-danceability" width="100%" height="100%"></svg> -->
      </div>
    </div>
  </div>

  <div class="col section-view section-view-right" id="right-panel">
    <div class="full-height-div">
      <div class="section-title" id="right-title">Your Playlist</div>
      <div class="fill-remaining-space-div" style="overflow-y:scroll">
        <svg id='your-playlist' class="collpase" width="100%" height="100%"></svg>
        <div id="right-player"></div>
        <div id="right-song-plot"></div>
        <ul class="list-group" id="custom-songs" style="max-height: 250px; overflow-y:scroll"></ul>
        <div class="section-title">manage your playlist</div>
        <div class="input-group mb-3" style="margin-top: 25px">
          <input type="text" class="form-control" placeholder="enter playlist name" id="name" aria-label="hi" aria-describedby="name-button">
          <button class="btn btn-outline-secondary" type="button" id="name-button">change playlist name</button>
        </div>
        <button type="button" class="btn btn-secondary" id="publish" style="visibility: hidden; margin-bottom: 10px;">publish playlist!</button>
      </div>
    </div>
  </div>
</div>


<style>
  body {
    background-color: var(--background-light);
    color: var(--text-light);
    font-family: 'Josefin Sans', sans-serif;
    font-weight: 300; 
    overflow: hidden;
  }
</style>

<script type="text/javascript" src="app.js"></script>

<script>

var examplePlaylist = JSON.parse(sessionStorage.playlist);
var yourPlaylist = JSON.parse(sessionStorage.yourPlaylist);

var visibleFeature = "all"; 

var infoBarVisible = false; 
function toggleInfoBar(){
  infoBarVisible = !infoBarVisible; 
  if(infoBarVisible){
    document.getElementById("infoBar").style.visibility = "visible"; 
    document.getElementById("infoBlur").style.visibility = "visible"; 
    document.getElementById("logo").style.visibility = "hidden"; 
    document.getElementById("infoIcon").style.visibility = "hidden"; 
  }
  else{
    document.getElementById("infoBar").style.visibility = "hidden"; 
    document.getElementById("infoBlur").style.visibility = "hidden"; 
    document.getElementById("logo").style.visibility = "visible"; 
    document.getElementById("infoIcon").style.visibility = "visible"; 
  }
}

function goHome() {
  sessionStorage.playlist = JSON.stringify(examplePlaylist);
  sessionStorage.yourPlaylist = JSON.stringify(yourPlaylist);
  window.location = 'playlist.html';
}

var removeSong;

d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-musical-ties/main/data/playListDataList.json").then(playlistData => {
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-musical-ties/main/data/trackData.json").then(trackData => {

  removeSong = function(song) {
    song.parentElement.remove();
    console.log(song.parentElement.id);
    yourPlaylist.track_ids = yourPlaylist.track_ids.filter(s => `${s}-custom` !== song.parentElement.id);
    console.log(yourPlaylist);
    drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
  }
  var ourWhite = "#ECEAF2"; 

  // append the svg object to the body of the page
  var svgHome = d3.select("svg#home")
  var widthHome = $("svg#home").width()
  var heightHome = $("svg#home").height()
  // svgHome.attr("viewBox", "0,0," + widthHome + "," + heightHome)

  // COLORS AND VISUAL VARIABLES
  // colors of features
  var colors = ["#f77e01","#FF29D8","#7C30FF","#6ca2ea","#b5d33d"].reverse();  
  // var colors = ["#FFB0C2", "#FF6DB5", "#FF29D8", "#C02CE6", "#7C30FF"]; 
    // var colors = ["#ffe942", "#ff7e38", "#FF29D8", "#C02CE6", "#7C30FF"]; 

  // colors = colors.reverse(); 
  // var colorsBright = ["#FFD7E0", "#FFDEEF", "#FFCAF5", "#F2BCFF", "#DAC5FF", "#ffa83d"]; 

  var colorsDark = ['#636b48', '#3e4d6b', '#513b80', '#6b2b65', '#77513b']

  // record colors 
  var darkerRecord = "#2d2b36";
  var lighterRecord = "#413f4a";
  
  // grid variables
  // it's all dependent on first variable 
  var numGridCols = 3; 
  var bubbleSize = (widthHome / (numGridCols + 1)) / 2; 
  var spacing = (widthHome / (numGridCols + 1)) / (numGridCols + 1) ; 
  var gridLeftOffset = spacing + (bubbleSize); 
  var gridTopOffset = gridLeftOffset; 
  var gridSpacingHorizontal = (bubbleSize*2) + spacing; 
  var gridSpacingVertical = gridSpacingHorizontal + 20; 

  var centerBubbleSize = bubbleSize / 3; 

  // order and values can be changed
  var features = [ "danceability", "energy", "valence", "acousticness", "speechiness"]; 
  features = features.reverse(); 

  var tooltip = d3.select("body").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);

  function getPlaylistInfo(pID){
    for (p of playlistData) {
      if(p.id == pID){
        return p; 
      }
    }
  }
  
  // playlistData = playlistData.filter(playlist => !(playlist['name'] in ['mint', 'Lorem', 'Heart of Texas'])); 

  // var sortselect = document.getElementById('sort');
  // sortselect.onchange = function(){
  //   const feature = document.getElementById('sort').value;
  //   if (feature === 'none'){
  //     svgHome.selectAll("circle")
  //     .style("fill-opacity", .3 )
  //     .style("fill", '#69b3a2'); 
  //   } else {
  //     var fIndex = features.indexOf(feature); 
  //     svgHome.selectAll("circle")
  //     .style("fill-opacity", function(d) {
  //       return getAverage(d, feature); 
  //     })
  //     .style("fill", colors[fIndex]); 
  //   }
    
  // };


  const feature_sliders = {
    DOMselector: '#sorting',
    sliders: []
  };

  let current_radius = 30;
  for (let i=0; i<features.length; i++){
    const current_slider = {
      radius: current_radius+20*i,
      min: 0,
      max: 1,
      step: .1,
      initialValue: 1,
      color: colors[i],
      displayName: features[i]
    };
    feature_sliders.sliders.push(current_slider);
  }
  // instantiate the slider
  const slider = new Slider(feature_sliders, sortSelection, featureSelection);
  slider.draw();

  // const placeholder = {
  //   DOMselector: '#sliders',
  //   sliders: [], 
  // };
  // const slider = new Slider(placeholder, sortSelection);
  // slider.draw();


  const slider_div = document.getElementById('sliders');
  let slider_radius = 23;
  let shift = (features.length-1) * 10;
  for (let i=0; i < features.length; i++) {
    slider_radius += 18;
    const div = document.createElement('div');
    div.id = 'slider-' + i.toString();
    slider_div.appendChild(div);

    $('#'+div.id).roundSlider({
      sliderType: "range",
      min: 0.0,
      max: 1.0,
      step: 0.1,
      value: "0.0, 1.0",
      startAngle: 90,
      radius: slider_radius,
      width: 12,
      change: function (e) {
        filterSongs(e, true);
        filterSongs(e, false);
      },
      showTooltip: false
      // svgMode: true
    });
    shift-=10;
  }

  const valuesDiv = document.getElementById('slider-values');
  for (let i = 0; i < features.length; i++) {
    let div = document.createElement('div');
    div.class = 'row';
    div.id = `${features[i]}-filter`;
    div.innerHTML = `${0.0} - ${1.0}`;
    div.style.color = colors[i];
    valuesDiv.appendChild(div);
  }

  var allSongs = JSON.parse(JSON.stringify(examplePlaylist));
  var allYourSongs = JSON.parse(JSON.stringify(yourPlaylist));
  function filterSongs(e, yours) {
    let valueDiv = document.getElementById(`${features[e.id.slice(-1)]}-filter`);
    let values = e.value.split(',');
    valueDiv.innerHTML = `${values[0]} - ${values[1]}`;

    // showPlaylists();
    if (!yours){
      d3.selectAll('path').remove(); 
      d3.selectAll('text').remove(); 
      drawPlaylist(allSongs, svg, 'svg#playlist', '#left-title', visibleFeature); 
      
      var included = JSON.parse(JSON.stringify(allSongs));
      included.track_ids = [];
      // var notIncluded = [];
      for (let t of allSongs.track_ids) {
        var include = true; 
        for (let i = 0; i < features.length; i++){
          const sliderID = `#slider-${i}`;
          let constraints = $(sliderID).roundSlider("getValue").split(',');
          const val = trackData[t]['features'][features[i]];
          if ((val < parseFloat(constraints[0])) || (val > parseFloat(constraints[1]))) {
            include = false;
            break;
          } 
        }
        if (include)
          included.track_ids.push(t);
        // else
        //   notIncluded.push(p);
      }

      examplePlaylist = included;
      d3.selectAll('path').remove(); 
      d3.selectAll('text').remove(); 
      drawPlaylist(included, svg, 'svg#playlist', '#left-title', visibleFeature); 
    } else{
      d3.selectAll('path').remove(); 
      d3.selectAll('text').remove(); 
      drawPlaylist(allYourSongs, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature); 
      
      var included = JSON.parse(JSON.stringify(allYourSongs));
      included.track_ids = [];
      // var notIncluded = [];
      for (let t of allYourSongs.track_ids) {
        var include = true; 
        for (let i = 0; i < features.length; i++){
          const sliderID = `#slider-${i}`;
          let constraints = $(sliderID).roundSlider("getValue").split(',');
          const val = trackData[t]['features'][features[i]];
          if ((val < parseFloat(constraints[0])) || (val > parseFloat(constraints[1]))) {
            include = false;
            break;
          } 
        }
        if (include)
          included.track_ids.push(t);
        // else
        //   notIncluded.push(p);
      }

      yourPlaylist = included;
      d3.selectAll('path').remove(); 
      d3.selectAll('text').remove(); 
      drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
    }
    
  }

  function featureSelection(){
    visibleFeature = 'all'; 
    for(var feat of features){
      if(document.getElementById('featureSelection' + feat).checked){
        visibleFeature = feat; 
        break; 
      }
    }


    d3.selectAll('path').remove(); 
    d3.selectAll('text').remove();
    
    drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title', visibleFeature); 
    drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
  }

  function sortSelection(){
    console.log("fuck off"); 

    // figure out selection
    var selectedSortFeature = 'none'; 
    for(var feat of features){
      if(document.getElementById('sortSelection' + feat).checked){
        selectedSortFeature = feat; 
        break; 
      }
    }

    if(selectedSortFeature != 'none'){
      // var objClass = "path." + selectedSortFeature; 
      svg.selectAll('path').data(examplePlaylist['track_ids']).exit().remove(); 
      yourSvg.selectAll('path').data(yourPlaylist['track_ids']).exit().remove(); 
      
      console.log(examplePlaylist['track_ids']); 
      examplePlaylist['track_ids'] =  sortByFeature(examplePlaylist, examplePlaylist['track_ids'], selectedSortFeature); 
      console.log(examplePlaylist['track_ids']); 
      yourPlaylist['track_ids'] = sortByFeature(yourPlaylist, yourPlaylist['track_ids'], selectedSortFeature); 
      console.log(examplePlaylist['track_ids']); 

      d3.selectAll('path').remove(); 
      d3.selectAll('text').remove();
      
      drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title', visibleFeature); 
      drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);

      // svg.selectAll(objClass).style("fill", getBrighterByFeature(selectedSortFeature)); 
      // yourSvg.selectAll(objClass).style("fill", getBrighterByFeature(selectedSortFeature)); 

      if(visibleFeature != "all"){
        return; 
      }
      var t = d3.transition()
        .duration(1500)
        .ease(d3.easeExpIn);

      for(var feat of features){
        objClass = "path." + feat;

        if(feat == selectedSortFeature){
          svg.selectAll(objClass).style("fill", getBrighterByFeature(feat)); 
          yourSvg.selectAll(objClass).style("fill", getBrighterByFeature(feat)); 
        }
        else{
          svg.selectAll(objClass).style("fill", getDarkerByFeature(feat)).transition(t).style("fill", getBrighterByFeature(feat));
          yourSvg.selectAll(objClass).style("fill", getDarkerByFeature(feat)).transition(t).style("fill", getBrighterByFeature(feat));;
        }
      }
    }
    else{
      d3.selectAll('path').remove(); 
      d3.selectAll('text').remove(); 
      drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title', visibleFeature); 
      drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
    }
  }

  function getBubbleData() {
    let data = [];
    let counted = []; 
    for (p of playlistData) {
      if(!(['mint', 'Lorem', 'Heart Of Texas', "Today's Top Hits", 'POLLEN', 'Beast Mode Hip-Hop', 'RADAR Country', 'Rock This', "Chillin' on a Dirt Road", "Ultimate Indie", "my life is a movie", "Breakout Country", "Pop Rising", "Teen Beats",  "I Love My '00s R&B"].includes(p.name))){
        if(!counted.includes(p.name)){
          let bubble = {};
          bubble.name = p['id'];
          data.push(bubble);
          counted.push(p.name); 
        }
      }
    }
    return data;
  }
   
  // input: playlist is entire playlist dictionary
  function getAverage(playlist, feature){
      return getAverageFromID(playlist.name, feature); 
  }

  // input: playlistID is just the ID
  function getAverageFromID(playlistID, feature){
    var sum = 0; 
    var total = 0; 
    for(p of playlistData ){
      if(p.id == playlistID){
        for(song of p['track_ids']){
          sum += trackData[song]['features'][feature]; 
        }
        total = p['track_ids'].length; 
        return sum / total; 
      }
    }
  }

  // returns an array of the average features
  function getAverageFeatures(playlistID){
    var feats = [];
    for(var i = 0; i < features.length; i++){
      feats.push(getAverageFromID(playlistID, features[i]));
    }
    return feats; 
  }

  // get average features for your new playlist
  function getYourAverageFeatures(){
    var feats = [];
    for(var i = 0; i < features.length; i++){
      var sum = 0; 
      var total = 0; 
      for(song of yourPlaylist['track_ids']){
        sum += trackData[song]['features'][features[i]];
      }
    }
    return feats; 
  }

  var svg = d3.select("svg#playlist").attr("preserveAspectRatio", "xMinYMin meet"); 
    // width = $("svg#playlist").width(),
    // height = $("svg#playlist").height(),
    // innerRadius = Math.min(width, height) / 15,
    // outerRadius = Math.min(width, height) / 2.5,
    // g = svg.append("g")
    //   .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")"); 

  var yourSvg = d3.select("svg#your-playlist").attr("preserveAspectRatio", "xMinYMin meet");
    // yourwidth = $("svg#your-playlist").width(),
    // height = $("svg#your-playlist").height(),
    // innerRadius = Math.min(width, height) / 6,
    // outerRadius = Math.min(width, height) / 2,
    // yourG = svg.append("g")
    //   .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")"); 

  drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title', visibleFeature); 
  if (yourPlaylist.track_ids.length > 0){
    drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
    d3.select('#publish').style('visibility', 'visible');
  }
  

  function getBrighterByFeature(feature){
    var ind = features.indexOf(feature); 
    return colors[ind];
  }

  function getDarkerByFeature(feature){
    var ind = features.indexOf(feature); 
    return colorsDark[ind];
  }

  function getBrighterByColor(color){
    for(var i = 0; i < colorsDark.length; i++){
      if(d3.rgb(colorsDark[i]) == color){
        return colors[i]; 
      }
    }

    return color;
  }

  function getDarkerByColor(color){
    for(var i = 0; i < colors.length; i++){
      if(d3.rgb(colors[i]) == color){
        return colorsDark[i]; 
      }
    }
    return color;
  }

  var selectedSong = ""; 
  var selectedRightSong = "";

  function drawPlaylist(currentPlaylist, svg, svg_id, panel_id, selectedSortFeature){
    if(selectedSortFeature == 'all')
    {
      selectedSortFeature = features;
    }
    else{
      selectedSortFeature = [selectedSortFeature];
    }

    width = $(svg_id).width(),
    height = $(svg_id).height(); 
    let factor = 0.8; 
    let innerRadius = Math.min(width, height) / 20; 
    let outerRadius = Math.min(width, height) / 2;
    let g = svg.append("g")
      .attr("transform", "translate(" + width / 2 + "," + outerRadius * factor + ")"); 

    var y = d3.scaleLinear()
    .range([innerRadius, outerRadius])
    .domain([0, 5]);

    svg.selectAll('path').data(currentPlaylist['track_ids']).exit().remove(); 
    // drawPlaylistLegend(currentPlaylist, svg, g, outerRadius, factor);
    // updatePlaylistDisplayInfo([currentPlaylist["name"]], g, outerRadius, factor);
    d3.select(panel_id).text(currentPlaylist["name"]);

    var x = d3.scaleBand()
    .range([0, 2 * Math.PI])
    .align(0)
    .domain(currentPlaylist["track_ids"]);

    selectedSortFeature.forEach((feature, i) => {
      g.append('g')
        .selectAll('path')
        .data(currentPlaylist['track_ids'])
        .join(
          enter => enter.append('path'),
          update => update,
          exit   => exit.remove()
        )
        .classed(feature, true)
        .style("fill", function(d) {
            if(selectedSortFeature.length > 1){
              return colors[i] 
            }
            else{
              return colors[features.indexOf(selectedSortFeature[0])]
            }
          
          })
          .attr("d", d3.arc() 
              .innerRadius(function(d) { 
                if(selectedSortFeature.length > 1){
                  return y(getFeatureStartPos(d, i));
                }
                else{
                  return y(getFeatureStartPos(d, 0));
                }})
              .outerRadius(function(d) { 
                if(selectedSortFeature.length > 1){
                  return y(getFeatureEndPos(d, i));
                }
                else{
                  return y(getOneFeatureEndPos(d, features.indexOf(selectedSortFeature[0])));
                }})
              .startAngle(function(d) { return x(d); })
              .endAngle(function(d) { return x(d) + x.bandwidth(); })
              .padAngle(0.005)
              .padRadius(innerRadius)
              )
      }); 

      g.append('g')
        .selectAll('path')
        .data([1, 2, 3])
        .join(
          enter => enter.append('path'),
          update => update,
          exit   => exit.remove()
        )
        .attr("d", d3.arc() 
          .innerRadius(function(d) { return y(d); })
          .outerRadius(function(d) { return y(d+0.02) }) // this val could be improved but whatever for now
          .startAngle(0)
          .endAngle(2*Math.PI)
          .padAngle(0.01)
          .padRadius(innerRadius)
          )
          .style('fill', "white")
          .style("opacity", "0.7")

      g.append('g')
        .selectAll('text')
        .data([1, 2, 3])
        .join(
          enter => enter.append('text'),
          update => update,
          exit   => exit.remove()
        )
          .text(function(d) { return d})
          .style('font-size', "14px")
          .style('fill', "white")
          .style("opacity", "1")
          .attr("x", function(d) { return y(d + 0.02);})

      g.append('g')
        .selectAll('path')
        .data(currentPlaylist['track_ids'])
        .join(
          enter => enter.append('path'),
          update => update,
          exit   => exit.remove()
        )
        .attr("opacity","0")
        .style('cursor', 'pointer')
        .attr("d", d3.arc() 
          .innerRadius(function(d) { return y(0); })
          .outerRadius(function(d) { return y(getTotalFeature(d)); }) // this val could be improved but whatever for now
          .startAngle(function(d) { return x(d); })
          .endAngle(function(d) { return x(d) + x.bandwidth(); })
          .padAngle(0.01)
          .padRadius(innerRadius)
          )
        .on("click", function(event, d, i){
          d3.select('#add-song').style('visibility', 'hidden');
          // displaySongInfoPlaylist(d, g, outerRadius, factor); 
          if (svg_id === 'svg#playlist'){
            plotSongInfo(d, 'left-song-plot');

            svg.selectAll("path")
              .style("fill", function(d){ return getDarkerByColor(this.style.fill)}) 
            if (selectedSong.length > 0){
              let oldElement = document.getElementById(selectedSong);
              oldElement.style.color = 'initial';
              oldElement.style.border = 'initial';
              oldElement.style['font-weight'] = 'initial';
            }

            if (d === selectedSong){
              document.getElementById('left-song-plot').innerHTML = '';
              svg.selectAll("path")
                .style("fill", function(d){ return getBrighterByColor(this.style.fill)}) 
              selectedSong = '';
              d3.select('#add-song').style('visibility', 'hidden');
              let player = document.getElementById('left-player');
              player.innerHTML = '';
            } else {
              selectedSong = d;
              svg.selectAll("path")
                .filter(d => d == selectedSong)
                .style("fill", function(d){ return getBrighterByColor(this.style.fill)})


              if (currentPlaylist === examplePlaylist){
                if (!yourPlaylist.track_ids.includes(selectedSong))
                  d3.select('#add-song').style('visibility', 'visible')
              } 

              let player = document.getElementById('left-player');
              player.innerHTML = `<iframe  src="https://open.spotify.com/embed/track/${d}" width="250" height="100" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;

              let listElement = document.getElementById(d);
              listElement.scrollIntoView({ 
                behavior: 'smooth' 
              });
              listElement.style.color = colors[3];
              listElement.style.border = `1px solid ${colors[3]}`;
              listElement.style['font-weight'] = '900';
            }
          } 

          else {
            plotSongInfo(d, 'right-song-plot');

            svg.selectAll("path")
              // .filter(d => d == selectedRightSong)
              .style("fill", function(d){ return getDarkerByColor(this.style.fill)}) 
            if (selectedRightSong.length > 0){
              let oldElement = document.getElementById(`${selectedRightSong}-custom`);
              oldElement.style.color = 'initial';
              oldElement.style.border = 'initial';
              oldElement.style['font-weight'] = 'initial';
            }

            if (d === selectedRightSong){
              document.getElementById('right-song-plot').innerHTML = '';
              svg.selectAll("path")
                .style("fill", function(d){ return getBrighterByColor(this.style.fill)}) 
              selectedRightSong = '';
              let player = document.getElementById('right-player');
              player.innerHTML = '';
            } else {
              selectedRightSong = d;
              svg.selectAll("path")
                .filter(d => d == selectedRightSong)
                .style("fill", function(d){ return getBrighterByColor(this.style.fill)})

              if (currentPlaylist === examplePlaylist){
                if (!yourPlaylist.track_ids.includes(selectedRightSong))
                  d3.select('#add-song').style('visibility', 'visible')
              } 

              let player = document.getElementById('right-player');
              player.innerHTML = `<iframe  src="https://open.spotify.com/embed/track/${d}" width="250" height="100" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;


              let listElement = document.getElementById(`${d}-custom`)
              listElement.scrollIntoView({ 
                behavior: 'smooth' 
              });
              listElement.style.color = colors[3];
              listElement.style.border = `1px solid ${colors[3]}`;
              listElement.style['font-weight'] = '900';
            }
          
          }

          // if (selectedSong.length > 0 && selectedRightSong.length > 0)
          //   compareSongs(selectedSong, selectedRightSong);
          
        })
        // .on("mouseout", function(event, d, i){
        //   // TODO i'm not sure this will work when we scale up
        //   updatePlaylistDisplayInfo([currentPlaylist["name"]]);
        //   var selectedSong = d;
        //   svg.selectAll("path")
        //     .filter(d => d == selectedSong)
        //     .style("fill", function(d){ return getDarkerByColor(this.style.fill)})
        // })

    let playlist = document.getElementById('songs');
    for (track of currentPlaylist['track_ids']) {
      let song = document.createElement('li');
      song.className = "list-group-item list-group-item-dark";
      song.id = track;
      song.innerHTML = trackData[track].title;
      playlist.appendChild(song);
    }

  }

  function compareSongs(song1, song2) {
    // remove previous plots
    if (document.getElementById('compare-songs').innerHTML.length > 0)
      document.getElementById('compare-songs').innerHTML = '';

    for (let i = 0; i < features.length; i++){
      // set the dimensions and margins of the graph
      // var divId = `svg#compare-${features[i]}`;
      let divId = '#compare-songs';
      var margin = {top: 30, right: 30, bottom: 150, left: 60},
        width = $(divId).width() - margin.left - margin.right,
        // setting to $(divId).height() breaks it
        height = $(divId).width() - margin.top - margin.bottom;
  
      var svg = d3.select(divId)
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
  
      data = [trackData[song1], trackData[song2]];

      // X axis
      var x = d3.scaleBand()
        .range([ 0, width ])
        .domain(data.map(function(d) { return d.title; }))
        .padding(0.2);
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end");
  
      // Add Y axis
      var y = d3.scaleLinear()
        .domain([0, 1])
        .range([ height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));

      // data.forEach(function(d) {
        // Bars
        svg.selectAll("mybar")
          .data(data)
          .enter()
          .append("rect")
            .attr("x", function(d) { 
              return x(d.title); })
            .attr("y", function(d) { 
              return y(d['features'][features[i]]); 
            })
            .attr("width", x.bandwidth())
            .attr("height", function(d) { return height - y(d['features'][features[i]]); })
            .attr("fill", colors[i])
        // })
      
    }

  }


  // init song list for your playlist
  for (track of yourPlaylist.track_ids){
    let playlist = document.getElementById('custom-songs');
    let song = document.createElement('li');
    song.className = "list-group-item list-group-item-dark";
    song.id = `${track}-custom`;
    song.innerHTML = `${trackData[track].title}<span class="material-icons" onclick="removeSong(this)">delete</span>`;
    playlist.appendChild(song);
  }

  const addButton = document.getElementById('add-song');
  addButton.onclick = function() {
    let playlist = document.getElementById('custom-songs');
    let song = document.createElement('li');
    song.className = "list-group-item list-group-item-dark";
    song.id = `${selectedSong}-custom`;
    song.innerHTML = `${trackData[selectedSong].title}<span class="material-icons" onclick="removeSong(this)">delete</span>`;
    playlist.appendChild(song);
    yourPlaylist.track_ids.push(selectedSong);
    drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
    d3.select('#publish').style('visibility', 'visible');
    d3.select('#add-song').style('visibility', 'hidden');
    // console.log(yourPlaylist);
  }
  // console.log(examplePlaylist);

  const nameButton = document.getElementById('name-button');
  nameButton.onclick = function() {
    console.log(yourPlaylist);
    let nameDiv = document.getElementById('name');
    yourPlaylist.name = nameDiv.value;
    d3.select('#right-title').text(nameDiv.value);
    console.log(yourPlaylist);
  }
  
  const publishButton = document.getElementById('publish');
  publishButton.onclick = function() {
    // console.log(yourPlaylist);
    if (sessionStorage.published === 'true'){
      let added = JSON.parse(sessionStorage.addedPlaylists);
      added.push(yourPlaylist);
      sessionStorage.addedPlaylists = JSON.stringify(added);
    } else {
      let added = [yourPlaylist];
      sessionStorage.addedPlaylists = JSON.stringify(added);
      sessionStorage.published = true;
    }
    
    const newID = `new${parseInt(yourPlaylist.id.slice(-1))+1}`;
    // console.log(newID);
    yourPlaylist = {
      'id' : newID,
      'name' : 'Your Playlist',
      'track_ids' : []
    };
    drawPlaylist(yourPlaylist, yourSvg, 'svg#your-playlist', '#right-title', visibleFeature);
    d3.select('#publish').style('visibility', 'hidden');
    // console.log(examplePlaylist);
    // console.log(yourPlaylist);
  }

  function displaySongInfoPlaylist(songID, g, outerRadius, factor){
    var songInfo = trackData[songID]; 
    var songFeatures = [songInfo['title']]; 
    for(var i = 0; i < features.length; i++){
      let info = "" + features[i] + " " + songInfo['features'][features[i]]; 
      songFeatures.push(info); 
    }
    updatePlaylistDisplayInfo(songFeatures, g, outerRadius, factor)
  }

  function plotSongInfo(songID, shortDivID) {
    // remove previous plots
    if (document.getElementById(shortDivID).innerHTML.length > 0)
      document.getElementById(shortDivID).innerHTML = '';


      // set the dimensions and margins of the graph
      // var divId = `svg#compare-${features[i]}`;
      let divId = `#${shortDivID}`;
      var margin = {top: 30, right: 30, bottom: 80, left: 60},
        width = $(divId).width() - margin.left - margin.right,
        // setting to $(divId).height() breaks it
        height = $(divId).width()*.8 - margin.top - margin.bottom;
  
      var svg = d3.select(divId)
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
  
      data = [];
      for (let i = 0; i < features.length; i++){
        let f = {};
        f.feature = features[i];
        f.value = trackData[songID]['features'][features[i]];
        f.color = colors[i];
        data.push(f);
      }

      // X axis
      var x = d3.scaleBand()
        .range([ 0, width ])
        .domain(data.map(function(d) { return d.feature; }))
        .padding(0.2);
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end");
  
      // Add Y axis
      var y = d3.scaleLinear()
        .domain([0, 1])
        .range([ height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));

      // data.forEach(function(d) {
        // Bars
        svg.selectAll("mybar")
          .data(data)
          .enter()
          .append("rect")
            .attr("x", function(d) { 
              return x(d.feature); })
            .attr("y", function(d) { 
              return y(d.value); 
            })
            .attr("width", x.bandwidth())
            .attr("height", function(d) { return height - y(d.value); })
            .attr("fill", function(d) { return d.color; })
        // })

  }

  function drawPlaylistLegend(examplePlaylist, svg, g, outerRadius, factor){
    // svg.selectAll('path').exit().remove(); 
    g.selectAll('rect.legend').data(features).join(
      enter => enter.append("rect"),
      update => update,
      exit   => exit.remove()
    )
    .style('cursor', 'pointer')
    .style("fill", function(d) {return colors[features.indexOf(d)]})
    .attr("stroke-width", 2)
    // .attr("fill-opacity", .4)
    .attr("width", 18)
    .attr("height", 18)
    .classed('legend', true)
    .attr("opacity", "1")
    .text(d => d)
    .attr("transform", (d, i) => `translate(${(-outerRadius)},${(i * 20 + 5 + outerRadius * factor)})`)
    .on("mouseenter", function(event, d){
      var objClass = "path." + d; 
      svg.selectAll(objClass).transition().style("fill", getBrighterByFeature(d))
      for(var feat of features){
        if(feat != d){
          svg.selectAll("path." + feat).transition().style("fill", getDarkerByFeature(feat))
        }
      }
    })
    .on("mouseout", function(event, d){
      // var objClass = "path." + d; 
      // svg.selectAll(objClass).style("fill", getBrighterByFeature(d))
      for(var feat of features){
        svg.selectAll("path." + feat).transition().style("fill", getBrighterByFeature(feat))
      }
    })
    .on("click", function(event, d){
      // TODO: do all this for custom playlist too
      // var objClass = "path." + d; 
      // svg.selectAll('path').data(examplePlaylist['track_ids']).exit().remove(); 
      // examplePlaylist['track_ids'] =  sortByFeature(examplePlaylist, examplePlaylist['track_ids'], d); 
      // // svg.selectAll(objClass).style("fill", getBrighter(this.style.fill))
      // drawPlaylist(examplePlaylist, svg, 'svg#playlist', '#left-title'); 
      // svg.selectAll(objClass).style("fill", getBrighterByFeature(d)); 

      // colorBubbles(d); 
    })
  }

  function updatePlaylistDisplayInfo(title, g, outerRadius, factor){
    if(title.length == 1){
      for(var i = 0; i < features.length; i++){
        title.push(features[i]); 
      }
    }

    // middle of playlist text
    g.selectAll("text.playlistInfo").exit().remove(); 
    g.selectAll("text.playlistInfo").data(title).join(
      enter => enter.append("text"),
      update => update,
      exit   => exit.remove()
    )
    .style("fill", "white")
    .attr("stroke-width", 2)
    // .attr("fill-opacity", .4)
    .classed('playlistInfo', true)
    .text(d => d)
    .attr("transform", (d, i) => `translate(${-outerRadius + 20},${(i * 20) + (outerRadius * factor)})`); 
  }

  function sortByFeature(examplePlaylist, songs, feature){
    // TODO might be better to not sort the original array? how do you get back to original config... hmm 
    // svg.selectAll('path').data(examplePlaylist['track_ids']).exit().remove();
    
    songs.sort(function(a, b) {
      return trackData[a]["features"][feature] - trackData[b]["features"][feature]; 
    }); 

    for(s of songs){
      console.log(trackData[s]["features"][feature] ); 
    }

    x = d3.scaleBand()
      .range([0, 2 * Math.PI])
      .align(0)
      .domain(songs);
    return songs; 
  }

  function getFeatureStartPos(songId, featureIndex){
    var total = 0;  
    for(var i = 0; i < featureIndex; i++){
      total += trackData[songId]["features"][features[i]];
    }
    return total; 
  }

  function getFeatureEndPos(songId, featureIndex){
    var total = getFeatureStartPos(songId, featureIndex);  
    total += trackData[songId]["features"][features[featureIndex]];
    return total; 
  }

  function getOneFeatureEndPos(songId, featureIndex){
    return trackData[songId]["features"][features[featureIndex]];
  }

  function getTotalFeature(songId){
    var total = 0; 
    for(var feat of features){
      total += trackData[songId]["features"][feat];
    }
    // console.log(total); 
    return total; 
  }


}); 
  
}); 


</script>